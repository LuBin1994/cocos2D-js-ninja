{"version":3,"sources":["..\\..\\..\\..\\assets\\script/assets\\script\\stage.js"],"names":["cc","Class","extends","Component","properties","stagePrefabs","doneStage","canRecycle","currentPlat","default","type","node","nextPlat","nextTwoPlat","onLoad","_this","configInit","stagePrefabInit","stageInit","init","game","opacity","gameInit","destroyAll","callbacks","i","loader","loadRes","err","prefab","push","length","nextX","distance","centerDistance","instantiate","Util","randomNum","setPosition","v2","parent","width","gameConfig","gameMoveSpeed","x","GameDataManager","toolChoose","stick","active","setStick","bridge","setBridge","energy","showCali","setCali","createStage","num1","num2","Math","floor","minMultiProbability","maxMultiProbability","chooseNum","setNextStage","num","stage","moveY","moveTo","fadeIn","ani","spawn","runAction","fog","showFog","recycleStage","removeChild","children","removeAllChildren","getLength","Object","minLength","maxLength","min","max","hideStage","showStage","update","dt","isMove","childrens"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;;;AACAA,GAAGC,KAAH,CAAS;AACLC,aAASF,GAAGG,SADP;AAELC,gBAAY;AACRC,sBAAc,EADN;AAERC,mBAAW,CAFH,EAEK;AACbC,oBAAY,KAHJ;AAIRC,qBAAa;AACTC,qBAAS,IADA;AAETC,kBAAMV,GAAGW;AAFA,SAJL;AAQRC,kBAAU;AACNH,qBAAS,IADH;AAENC,kBAAMV,GAAGW;AAFH,SARF;AAYRE,qBAAa;AACTJ,qBAAS,IADA;AAETC,kBAAMV,GAAGW;AAFA;AAZL,KAFP;AAmBLG,UAnBK,oBAmBI;AACL,YAAIC,QAAQ,IAAZ;AACA,aAAKC,UAAL;AACA,aAAKC,eAAL,CAAqB,YAAY;AAAEF,kBAAMG,SAAN;AAAoB,SAAvD;AACH,KAvBI;;AAwBLC,UAAM,cAAUC,IAAV,EAAgB;AAClB,aAAKA,IAAL,GAAYA,IAAZ;AACH,KA1BI;AA2BLJ,gBAAW,sBAAU;AACjB,aAAKL,IAAL,CAAUU,OAAV,GAAoB,GAApB;AACA,aAAKd,UAAL,GAAkB,KAAlB;AACA,aAAKD,SAAL,GAAiB,CAAjB;AACH,KA/BI;AAgCLgB,cAAU,oBAAY;AAClB,aAAKC,UAAL;AACA,aAAKP,UAAL;AACA,aAAKE,SAAL;AACH,KApCI;AAqCL;AACAD,qBAAiB,yBAAUO,SAAV,EAAqB;AAClC,YAAIT,QAAQ,IAAZ;AACA,aAAK,IAAIU,IAAI,CAAb,EAAgBA,IAAI,CAApB,EAAuBA,GAAvB,EAA4B;AACxBzB,eAAG0B,MAAH,CAAUC,OAAV,CAAkB,iBAAiBF,IAAI,CAArB,CAAlB,EAA2C,UAAUG,GAAV,EAAeC,MAAf,EAAuB;AAC9Dd,sBAAMV,YAAN,CAAmByB,IAAnB,CAAwBD,MAAxB;AACA,oBAAId,MAAMV,YAAN,CAAmB0B,MAAnB,IAA6B,CAAjC,EAAoC;AAChCP,iCAAaA,WAAb;AACH;AACJ,aALD;AAMH;AACJ,KAhDI;AAiDL;AACAN,eAAW,qBAAY;AACnB,YAAIc,KAAJ,EAAUC,QAAV,EAAmBC,cAAnB;AACA;AACA,aAAK1B,WAAL,GAAmBR,GAAGmC,WAAH,CAAe,KAAK9B,YAAL,CAAkB+B,eAAKC,SAAL,CAAe,CAAf,CAAlB,CAAf,CAAnB;AACA,aAAK7B,WAAL,CAAiB8B,WAAjB,CAA6BtC,GAAGuC,EAAH,CAAM,CAAC,GAAP,EAAY,CAAC,GAAb,CAA7B;AACA,aAAK/B,WAAL,CAAiBgC,MAAjB,GAA0B,KAAK7B,IAA/B;;AAEA;AACA,aAAKC,QAAL,GAAgBZ,GAAGmC,WAAH,CAAe,KAAK9B,YAAL,CAAkB+B,eAAKC,SAAL,CAAe,CAAf,CAAlB,CAAf,CAAhB;AACAJ,mBAAWG,eAAKC,SAAL,CAAe,GAAf,IAAoB,GAA/B,CATmB,CASgB;AACnCH,yBAAiBD,YAAY,KAAKzB,WAAL,CAAiBiC,KAAjB,GAAuB,CAAvB,GAA2B,KAAK7B,QAAL,CAAc6B,KAAd,GAAoB,CAA3D,CAAjB;AACAP,yBAAiBA,iBAAiBA,iBAAeQ,qBAAWC,aAA5D,CAXmB,CAWuD;AAC1EX,gBAAQ,KAAKxB,WAAL,CAAiBoC,CAAjB,GAAmBV,cAA3B;AACA,aAAKtB,QAAL,CAAc0B,WAAd,CAA0BtC,GAAGuC,EAAH,CAAMP,KAAN,EAAa,CAAC,GAAd,CAA1B;AACA,aAAKpB,QAAL,CAAc4B,MAAd,GAAuB,KAAK7B,IAA5B;;AAEA;AACA,gBAAOkC,0BAAgBC,UAAvB;AACI,iBAAK,CAAL;AACI,qBAAK1B,IAAL,CAAU2B,KAAV,CAAgBpC,IAAhB,CAAqBqC,MAArB,GAA8B,IAA9B;AACA,qBAAK5B,IAAL,CAAU2B,KAAV,CAAgBE,QAAhB,CAAyB,KAAKzC,WAAL,CAAiBoC,CAAjB,GAAqB,KAAKpC,WAAL,CAAiBiC,KAAjB,GAAyB,CAAvE;AACA;AACJ,iBAAK,CAAL;AACI,qBAAKrB,IAAL,CAAU8B,MAAV,CAAiBvC,IAAjB,CAAsBqC,MAAtB,GAA+B,IAA/B;AACA,qBAAK5B,IAAL,CAAU8B,MAAV,CAAiBC,SAAjB,CAA2B,KAAK3C,WAAL,CAAiBoC,CAAjB,GAAqB,KAAKpC,WAAL,CAAiBiC,KAAjB,GAAyB,CAAzE;AACA;AACJ,iBAAK,CAAL;AACI,qBAAKrB,IAAL,CAAUgC,MAAV,CAAiBC,QAAjB;AACA,qBAAKjC,IAAL,CAAUgC,MAAV,CAAiBE,OAAjB;AACA;AAZR;AAcA;AACA,aAAKzC,WAAL,GAAmBb,GAAGmC,WAAH,CAAe,KAAK9B,YAAL,CAAkB+B,eAAKC,SAAL,CAAe,CAAf,CAAlB,CAAf,CAAnB;AACAJ,mBAAWG,eAAKC,SAAL,CAAe,GAAf,IAAoB,GAA/B,CAjCmB,CAiCgB;AACnCH,yBAAiBD,YAAY,KAAKrB,QAAL,CAAc6B,KAAd,GAAoB,CAApB,GAAwB,KAAK5B,WAAL,CAAiB4B,KAAjB,GAAuB,CAA3D,CAAjB;AACAP,yBAAiBA,iBAAiBA,iBAAeQ,qBAAWC,aAA5D,CAnCmB,CAmCuD;AAC1EX,gBAAQ,KAAKpB,QAAL,CAAcgC,CAAd,GAAgBV,cAAxB;AACA,aAAKrB,WAAL,CAAiByB,WAAjB,CAA6BtC,GAAGuC,EAAH,CAAMP,KAAN,EAAa,CAAC,GAAd,CAA7B;AACA,aAAKnB,WAAL,CAAiB2B,MAAjB,GAA0B,KAAK7B,IAA/B;AACH,KAzFI;AA0FL4C,iBAAa,uBAAY;AACrB,aAAKjD,SAAL,IAAkB,CAAlB;AACA,YAAIkD,OAAOpB,eAAKC,SAAL,CAAe,GAAf,CAAX;AACA,YAAIoB,OAAO,MAAIC,KAAKC,KAAL,CAAW,KAAKrD,SAAL,GAAe,CAA1B,CAAJ,GAAiCoC,qBAAWkB,mBAAX,GAA+B,GAA3E;AACA,YAAGH,OAAK,OAAK,IAAEf,qBAAWmB,mBAAlB,CAAR,EAA+C;AAC3CJ,mBAAO,OAAK,IAAEf,qBAAWmB,mBAAlB,CAAP;AACH;AACD,YAAIC,YAAY1B,eAAKC,SAAL,CAAe,CAAf,CAAhB;AACA,YAAImB,OAAOC,IAAX,EAAiB;AAAI;AACjB,iBAAKM,YAAL,CAAkBD,SAAlB;AACH,SAFD,MAGK;AAAI;AACL,gBAAGjB,0BAAgBC,UAAhB,IAA8B,CAAjC,EAAmC;AAC/B,qBAAKiB,YAAL,CAAkBD,YAAY,CAA9B;AACH,aAFD,MAGI;AACA,qBAAKC,YAAL,CAAkBD,YAAY,CAA9B;AACH;AACJ;AACJ,KA7GI;AA8GL;AACAC,kBAAc,sBAAUC,GAAV,EAAe;AACzB,YAAIC,KAAJ,EAAUjC,KAAV,EAAgBC,QAAhB,EAAyBC,cAAzB;AACA,aAAK1B,WAAL,GAAmB,KAAKI,QAAxB;AACA,aAAKA,QAAL,GAAgB,KAAKC,WAArB;AACAoD,gBAAQjE,GAAGmC,WAAH,CAAe,KAAK9B,YAAL,CAAkB2D,GAAlB,CAAf,CAAR;AACA,aAAKnD,WAAL,GAAmBoD,KAAnB;AACA,aAAKpD,WAAL,CAAiB2B,MAAjB,GAA0B,KAAK7B,IAA/B;AACA,aAAKE,WAAL,CAAiBQ,OAAjB,GAA2B,CAA3B;AACAY,mBAAWG,eAAKC,SAAL,CAAe,GAAf,IAAoB,GAA/B,CARyB,CAQU;AACnCH,yBAAiBD,YAAY,KAAKrB,QAAL,CAAc6B,KAAd,GAAoB,CAApB,GAAwB,KAAK5B,WAAL,CAAiB4B,KAAjB,GAAuB,CAA3D,CAAjB;AACAP,yBAAiBA,iBAAiBA,iBAAeQ,qBAAWC,aAA5D,CAVyB,CAUiD;AAC1EX,gBAAQ,KAAKpB,QAAL,CAAcgC,CAAd,GAAkBV,cAA1B;AACA,aAAKrB,WAAL,CAAiByB,WAAjB,CAA6BtC,GAAGuC,EAAH,CAAMP,KAAN,EAAa,CAAC,GAAd,CAA7B;AACA;AACA,YAAIkC,QAAQlE,GAAGmE,MAAH,CAAU,CAAV,EAAYnE,GAAGuC,EAAH,CAAMP,KAAN,EAAY,CAAC,GAAb,CAAZ,CAAZ;AACA,YAAIoC,SAASpE,GAAGoE,MAAH,CAAU,CAAV,CAAb;AACA,YAAIC,MAAMrE,GAAGsE,KAAH,CAASJ,KAAT,EAAeE,MAAf,CAAV;AACA,aAAKvD,WAAL,CAAiB0D,SAAjB,CAA2BF,GAA3B;;AAEA;AACA,YAAGxB,0BAAgBC,UAAhB,KAA+B,CAAlC,EAAoC;AAChC,gBAAG,KAAKxC,SAAL,GAAe,CAAf,IAAoB,CAAvB,EAAyB;AACrB,qBAAKc,IAAL,CAAUoD,GAAV,CAAcC,OAAd,CAAsB,KAAK7D,QAAL,CAAcgC,CAApC,EAAsC,CAAC,GAAvC;AACH;AACJ;AACD,YAAGC,0BAAgBC,UAAhB,IAA8B,CAAjC,EAAmC;AAC/B;AACA,iBAAK1B,IAAL,CAAUgC,MAAV,CAAiBE,OAAjB;AACH;AACJ,KA5II;AA6IL;AACAoB,kBAAc,wBAAY;AACtB,aAAK/D,IAAL,CAAUgE,WAAV,CAAsB,KAAKhE,IAAL,CAAUiE,QAAV,CAAmB,CAAnB,CAAtB;AACH,KAhJI;AAiJL;AACArD,gBAAW,sBAAU;AACjB,aAAKZ,IAAL,CAAUkE,iBAAV,CAA4B,IAA5B;AACH,KApJI;AAqJL;AACAC,aAtJK,uBAsJM;AACP,YAAI/C,SAAS,IAAIgD,MAAJ,EAAb;AACA;AACA,YAAIC,YAAYtB,KAAKC,KAAL,CAAY,KAAK/C,QAAL,CAAcgC,CAAd,GAAkB,KAAKpC,WAAL,CAAiBoC,CAApC,GAAyC,CAAC,KAAKhC,QAAL,CAAc6B,KAAd,GAAsB,KAAKjC,WAAL,CAAiBiC,KAAxC,IAA+C,CAAnG,CAAhB;AACA;AACA,YAAIwC,YAAWvB,KAAKC,KAAL,CAAY,KAAK/C,QAAL,CAAcgC,CAAd,GAAkB,KAAKpC,WAAL,CAAiBoC,CAApC,GAAyC,CAAC,KAAKhC,QAAL,CAAc6B,KAAd,GAAsB,KAAKjC,WAAL,CAAiBiC,KAAxC,IAA+C,CAAnG,CAAf;AACAV,eAAOmD,GAAP,GAAaF,SAAb;AACAjD,eAAOoD,GAAP,GAAaF,SAAb;AACA,eAAOlD,MAAP;AACH,KA/JI;AAgKLqD,aAhKK,uBAgKM;AACP,aAAKzE,IAAL,CAAUU,OAAV,GAAoB,CAApB;AACH,KAlKI;AAmKLgE,aAnKK,uBAmKM;AACP,aAAK1E,IAAL,CAAUU,OAAV,GAAoB,GAApB;AACH,KArKI;AAsKLiE,UAtKK,kBAsKEC,EAtKF,EAsKM;AACP,YAAI1C,0BAAgB2C,MAApB,EAA4B;AACxB;AACA,gBAAIC,YAAY,KAAK9E,IAAL,CAAUiE,QAA1B;AACA,iBAAK,IAAInD,IAAI,CAAb,EAAgBA,IAAIgE,UAAU1D,MAA9B,EAAsCN,GAAtC,EACA;AACIgE,0BAAUhE,CAAV,EAAamB,CAAb,IAAkBF,qBAAWC,aAA7B;AACH;AACJ;AACJ;AA/KI,CAAT","file":"stage.js","sourceRoot":"..\\..\\..\\..\\assets\\script","sourcesContent":["import gameConfig from './gameConfig' ;\nimport GameDataManager from './gameDataManager';\nimport Util from './utils/util' ;\ncc.Class({\n    extends: cc.Component,\n    properties: {\n        stagePrefabs: [],\n        doneStage: 0,//已通过的站台数\n        canRecycle: false,\n        currentPlat: {\n            default: null,\n            type: cc.node,\n        },\n        nextPlat: {\n            default: null,\n            type: cc.node,\n        },\n        nextTwoPlat: {\n            default: null,\n            type: cc.node,\n        }\n    },\n    onLoad() {\n        var _this = this;\n        this.configInit();\n        this.stagePrefabInit(function () { _this.stageInit(); });\n    },\n    init: function (game) {\n        this.game = game;\n    },\n    configInit:function(){\n        this.node.opacity = 255;\n        this.canRecycle = false;\n        this.doneStage = 0;\n    },\n    gameInit: function () {\n        this.destroyAll();\n        this.configInit();\n        this.stageInit();\n    },\n    //对象池，预制初始化\n    stagePrefabInit: function (callbacks) {\n        var _this = this;\n        for (var i = 0; i < 6; i++) {\n            cc.loader.loadRes(\"stage/stage\" + (i + 1), function (err, prefab) {\n                _this.stagePrefabs.push(prefab);\n                if (_this.stagePrefabs.length == 6) {\n                    callbacks && callbacks();\n                }\n            });\n        }\n    },\n    //站桩初始化\n    stageInit: function () {\n        var nextX,distance,centerDistance; \n        //第一个站桩\n        this.currentPlat = cc.instantiate(this.stagePrefabs[Util.randomNum(3)]);\n        this.currentPlat.setPosition(cc.v2(-230, -295));\n        this.currentPlat.parent = this.node;\n\n        //第二个站桩\n        this.nextPlat = cc.instantiate(this.stagePrefabs[Util.randomNum(3)]);\n        distance = Util.randomNum(250)+100;//随机距离\n        centerDistance = distance + (this.currentPlat.width/2 + this.nextPlat.width/2)\n        centerDistance = centerDistance - centerDistance%gameConfig.gameMoveSpeed;//两站装中心距离设置为移动速度的整数倍，防止移动过程中出现的偏差\n        nextX = this.currentPlat.x+centerDistance;\n        this.nextPlat.setPosition(cc.v2(nextX, -295));\n        this.nextPlat.parent = this.node;\n\n        //初始化设置道具\n        switch(GameDataManager.toolChoose){\n            case 0:\n                this.game.stick.node.active = true;\n                this.game.stick.setStick(this.currentPlat.x + this.currentPlat.width / 2);\n                break;\n            case 1:\n                this.game.bridge.node.active = true;\n                this.game.bridge.setBridge(this.currentPlat.x + this.currentPlat.width / 2);\n                break;\n            case 2:\n                this.game.energy.showCali();\n                this.game.energy.setCali();\n                break;\n        }\n        //第三个站桩\n        this.nextTwoPlat = cc.instantiate(this.stagePrefabs[Util.randomNum(3)]);\n        distance = Util.randomNum(250)+100;//随机距离\n        centerDistance = distance + (this.nextPlat.width/2 + this.nextTwoPlat.width/2);\n        centerDistance = centerDistance - centerDistance%gameConfig.gameMoveSpeed;//两站装中心距离设置为移动速度的整数倍，防止移动过程中出现的偏差\n        nextX = this.nextPlat.x+centerDistance;\n        this.nextTwoPlat.setPosition(cc.v2(nextX, -295));\n        this.nextTwoPlat.parent = this.node;\n    },\n    createStage: function () {\n        this.doneStage += 1;\n        var num1 = Util.randomNum(100);\n        var num2 = 100-Math.floor(this.doneStage/2)-gameConfig.minMultiProbability*100;\n        if(num2<100*(1-gameConfig.maxMultiProbability)){\n            num2 = 100*(1-gameConfig.maxMultiProbability);\n        }\n        var chooseNum = Util.randomNum(3);\n        if (num1 < num2) {   //抽取普通站台\n            this.setNextStage(chooseNum);\n        }\n        else {   //抽取多得分站台\n            if(GameDataManager.toolChoose == 1){\n                this.setNextStage(chooseNum + 2);\n            }\n            else{\n                this.setNextStage(chooseNum + 3);\n            }\n        }\n    },\n    //设置下一个站桩\n    setNextStage: function (num) {\n        var stage,nextX,distance,centerDistance;\n        this.currentPlat = this.nextPlat;\n        this.nextPlat = this.nextTwoPlat;\n        stage = cc.instantiate(this.stagePrefabs[num]);\n        this.nextTwoPlat = stage;\n        this.nextTwoPlat.parent = this.node;\n        this.nextTwoPlat.opacity = 0;\n        distance = Util.randomNum(250)+100;//随机距离\n        centerDistance = distance + (this.nextPlat.width/2 + this.nextTwoPlat.width/2);\n        centerDistance = centerDistance - centerDistance%gameConfig.gameMoveSpeed;//两站装中心距离设置为移动速度的整数倍，防止移动过程中出现的偏差\n        nextX = this.nextPlat.x + centerDistance;\n        this.nextTwoPlat.setPosition(cc.v2(nextX, -605));\n        //新生成的站台动画\n        var moveY = cc.moveTo(1,cc.v2(nextX,-295));\n        var fadeIn = cc.fadeIn(1);\n        var ani = cc.spawn(moveY,fadeIn);\n        this.nextTwoPlat.runAction(ani);\n\n        //选择下个道具\n        if(GameDataManager.toolChoose !== 2){\n            if(this.doneStage%5 == 0){\n                this.game.fog.showFog(this.nextPlat.x,-295)\n            }\n        }\n        if(GameDataManager.toolChoose == 2){\n            //设置能量条刻度\n            this.game.energy.setCali();\n        }\n    },\n    //游戏一回合结束删除经过的站桩\n    recycleStage: function () {\n        this.node.removeChild(this.node.children[0]);\n    },\n    //删除所有站桩\n    destroyAll:function(){\n        this.node.removeAllChildren(true);\n    },\n    //获取到下一个站桩的最小距离和最大距离\n    getLength(){\n        var length = new Object();\n        //道具搭桥成功所需的最小长度\n        var minLength = Math.floor((this.nextPlat.x - this.currentPlat.x) - (this.nextPlat.width + this.currentPlat.width)/2);\n        //道具搭桥成功所需的最大长度\n        var maxLength =Math.floor((this.nextPlat.x - this.currentPlat.x) + (this.nextPlat.width - this.currentPlat.width)/2);\n        length.min = minLength;\n        length.max = maxLength;\n        return length;\n    },\n    hideStage(){\n        this.node.opacity = 0;\n    },\n    showStage(){\n        this.node.opacity = 255;\n    },\n    update(dt) {\n        if (GameDataManager.isMove) {\n            //所有站桩左移\n            var childrens = this.node.children;\n            for (var i = 0; i < childrens.length; i++)\n            {\n                childrens[i].x -= gameConfig.gameMoveSpeed\n            }\n        }\n    },\n})\n\n"]}