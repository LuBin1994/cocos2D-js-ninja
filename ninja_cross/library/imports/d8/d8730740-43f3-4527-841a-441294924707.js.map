{"version":3,"sources":["..\\..\\..\\..\\assets\\script/assets\\script\\stage.js"],"names":["cc","Class","extends","Component","properties","stagePrefabs","doneStage","canRecycle","currentPlat","default","type","node","nextPlat","nextTwoPlat","onLoad","_this","configInit","stagePrefabInit","stageInit","init","game","opacity","gameInit","destroyAll","callbacks","loader","loadRes","err","prefab","push","e","Util","gameLog","nextX","distance","centerDistance","instantiate","randomNum","setPosition","v2","parent","width","gameConfig","gameMoveSpeed","x","GameDataManager","toolChoose","stick","active","setStick","bridge","setBridge","energy","showCali","setCali","createStage","num1","num2","Math","floor","minMultiProbability","maxMultiProbability","chooseNum","setNextStage","num","stage","moveY","moveTo","fadeIn","ani","spawn","runAction","fog","showFog","recycleStage","removeChild","children","removeAllChildren","getLength","length","Object","minLength","maxLength","min","max","hideStage","showStage","update","dt","isMove","childrens","i"],"mappings":"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","file":"stage.js","sourceRoot":"..\\..\\..\\..\\assets\\script","sourcesContent":["import gameConfig from './gameConfig' ;\nimport GameDataManager from './gameDataManager';\nimport Util from './utils/util' ;\ncc.Class({\n    extends: cc.Component,\n    properties: {\n        stagePrefabs: [],\n        doneStage: 0,//已通过的站台数\n        canRecycle: false,\n        currentPlat: {\n            default: null,\n            type: cc.node,\n        },\n        nextPlat: {\n            default: null,\n            type: cc.node,\n        },\n        nextTwoPlat: {\n            default: null,\n            type: cc.node,\n        }\n    },\n    onLoad() {\n        var _this = this;\n        this.configInit();\n        this.stagePrefabInit(function () { _this.stageInit(); });\n    },\n    init: function (game) {\n        this.game = game;\n    },\n    configInit:function(){\n        this.node.opacity = 255;\n        this.canRecycle = false;\n        this.doneStage = 0;\n    },\n    gameInit: function () {\n        this.destroyAll();\n        this.configInit();\n        this.stageInit();\n    },\n    //对象池，预制初始化\n    stagePrefabInit: function (callbacks) {\n        var _this = this;\n        try {\n            cc.loader.loadRes(\"stage/stage\" + 1, function (err, prefab) {\n                _this.stagePrefabs.push(prefab);\n                cc.loader.loadRes(\"stage/stage\" + 2, function (err, prefab) {\n                    _this.stagePrefabs.push(prefab);\n                    cc.loader.loadRes(\"stage/stage\" + 3, function (err, prefab) {\n                        _this.stagePrefabs.push(prefab);\n                        cc.loader.loadRes(\"stage/stage\" + 4, function (err, prefab) {\n                            _this.stagePrefabs.push(prefab);\n                            cc.loader.loadRes(\"stage/stage\" + 5, function (err, prefab) {\n                                _this.stagePrefabs.push(prefab);\n                                cc.loader.loadRes(\"stage/stage\" + 6, function (err, prefab) {\n                                    _this.stagePrefabs.push(prefab);\n                                    callbacks && callbacks();\n                                })\n                            })\n                        })\n                    })\n                })\n            })\n        }\n        catch (e) {\n            Util.gameLog(1,\"站桩预制加载出错\")\n        }\n\n    },\n    //站桩初始化\n    stageInit: function () {\n        var nextX,distance,centerDistance; \n        //第一个站桩\n        this.currentPlat = cc.instantiate(this.stagePrefabs[Util.randomNum(3)]);\n        this.currentPlat.setPosition(cc.v2(-230, -295));\n        this.currentPlat.parent = this.node;\n        //第二个站桩\n        this.nextPlat = cc.instantiate(this.stagePrefabs[Util.randomNum(3)]);\n        distance = Util.randomNum(250)+100;//随机距离\n        centerDistance = distance + (this.currentPlat.width/2 + this.nextPlat.width/2)\n        centerDistance = centerDistance - centerDistance%gameConfig.gameMoveSpeed;//两站装中心距离设置为移动速度的整数倍，防止移动过程中出现的偏差\n        nextX = this.currentPlat.x+centerDistance;\n        this.nextPlat.setPosition(cc.v2(nextX, -295));\n        this.nextPlat.parent = this.node;\n\n        //第三个站桩\n        this.nextTwoPlat = cc.instantiate(this.stagePrefabs[Util.randomNum(3)]);\n        distance = Util.randomNum(250)+100;//随机距离\n        centerDistance = distance + (this.nextPlat.width/2 + this.nextTwoPlat.width/2);\n        centerDistance = centerDistance - centerDistance%gameConfig.gameMoveSpeed;//两站装中心距离设置为移动速度的整数倍，防止移动过程中出现的偏差\n        nextX = this.nextPlat.x+centerDistance;\n        this.nextTwoPlat.setPosition(cc.v2(nextX, -295));\n        this.nextTwoPlat.parent = this.node;\n\n        //初始化设置道具\n        switch(GameDataManager.toolChoose){\n            case 0:\n                this.game.stick.node.active = true;\n                this.game.stick.setStick(this.currentPlat.x + this.currentPlat.width / 2);\n                break;\n            case 1:\n                this.game.bridge.node.active = true;\n                this.game.bridge.setBridge(this.currentPlat.x + this.currentPlat.width / 2);\n                break;\n            case 2:\n                this.game.energy.showCali();\n                this.game.energy.setCali();\n                break;\n        }\n    },\n    createStage: function () {\n        this.doneStage += 1;\n        var num1 = Util.randomNum(100);\n        var num2 = 100-Math.floor(this.doneStage/2)-gameConfig.minMultiProbability*100;\n        if(num2<100*(1-gameConfig.maxMultiProbability)){\n            num2 = 100*(1-gameConfig.maxMultiProbability);\n        }\n        var chooseNum = Util.randomNum(3);\n        if (num1 < num2) {   //抽取普通站台\n            this.setNextStage(chooseNum);\n        }\n        else {   //抽取多得分站台\n            if(GameDataManager.toolChoose == 1){\n                this.setNextStage(chooseNum + 2);\n            }\n            else{\n                this.setNextStage(chooseNum + 3);\n            }\n        }\n    },\n    //设置下一个站桩\n    setNextStage: function (num) {\n        var stage,nextX,distance,centerDistance;\n        this.currentPlat = this.nextPlat;\n        this.nextPlat = this.nextTwoPlat;\n        stage = cc.instantiate(this.stagePrefabs[num]);\n        this.nextTwoPlat = stage;\n        this.nextTwoPlat.parent = this.node;\n        this.nextTwoPlat.opacity = 0;\n        distance = Util.randomNum(250)+100;//随机距离\n        centerDistance = distance + (this.nextPlat.width/2 + this.nextTwoPlat.width/2);\n        centerDistance = centerDistance - centerDistance%gameConfig.gameMoveSpeed;//两站装中心距离设置为移动速度的整数倍，防止移动过程中出现的偏差\n        nextX = this.nextPlat.x + centerDistance;\n        this.nextTwoPlat.setPosition(cc.v2(nextX, -605));\n        //新生成的站台动画\n        var moveY = cc.moveTo(1,cc.v2(nextX,-295));\n        var fadeIn = cc.fadeIn(1);\n        var ani = cc.spawn(moveY,fadeIn);\n        this.nextTwoPlat.runAction(ani);\n\n        //选择下个道具\n        if(GameDataManager.toolChoose !== 2){\n            if(this.doneStage%5 == 0){\n                this.game.fog.showFog(this.nextPlat.x,-305)\n            }\n        }\n        if(GameDataManager.toolChoose == 2){\n            //设置能量条刻度\n            this.game.energy.setCali();\n        }\n    },\n    //游戏一回合结束删除经过的站桩\n    recycleStage: function () {\n        this.node.removeChild(this.node.children[0]);\n    },\n    //删除所有站桩\n    destroyAll:function(){\n        this.node.removeAllChildren(true);\n    },\n    //获取到下一个站桩的最小距离和最大距离\n    getLength(){\n        var length = new Object();\n        //道具搭桥成功所需的最小长度\n        var minLength = Math.floor((this.nextPlat.x - this.currentPlat.x) - (this.nextPlat.width + this.currentPlat.width)/2);\n        //道具搭桥成功所需的最大长度\n        var maxLength =Math.floor((this.nextPlat.x - this.currentPlat.x) + (this.nextPlat.width - this.currentPlat.width)/2);\n        length.min = minLength;\n        length.max = maxLength;\n        return length;\n    },\n    hideStage(){\n        this.node.opacity = 0;\n    },\n    showStage(){\n        this.node.opacity = 255;\n    },\n    update(dt) {\n        if (GameDataManager.isMove) {\n            //所有站桩左移\n            var childrens = this.node.children;\n            for (var i = 0; i < childrens.length; i++)\n            {\n                childrens[i].x -= gameConfig.gameMoveSpeed\n            }\n        }\n    },\n})\n\n"]}